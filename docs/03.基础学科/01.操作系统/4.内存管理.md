---
title: 内存管理
date: 2021-03-20 15:50:06
permalink: /pages/2667d5/
categories:
  - 基础学科
  - 操作系统
tags:
  - 
---



## 基本概念

### 内存分页和内存分段

内存分页分为一个页号还有一个偏移量，我们通过页号查找页表，找出对应地址，然后加上偏移量就可以得到最终地址

![image-20210304165813475](https://img.xiaoyou66.com/2021/03/23/29f1ff4a1ccca.png)

![image-20210304165933575](https://img.xiaoyou66.com/2021/03/23/b954d7500b353.png)

内存分段的步骤如下

1. 先提取段号
2. 然后查找段表找出这段的起始物理地址
3. 然后比较偏移量和端长度，如果超出则无效
4. 物理地址等于 端起始地址+段内偏移量

![image-20210323223337442](https://img.xiaoyou66.com/2021/03/23/02d1cc9ed2602.png)

### 内存置换算法

- **最佳页面置换算法**OPT（Optimal replacement algorithm） 置换以后不需要或者最远的将来才需要的页面，是一种理论上的算法，是最优策略；
- **先进先出**FIFO 置换在内存中驻留时间最长的页面。缺点：有可能将那些经常被访问的页面也被换出，从而使缺页率升高；
- **第二次机会算法**SCR 按FIFO选择某一页面，若其访问位为1，给第二次机会，并将访问位置0；
- **时钟算法** Clock：SCR中需要将页面在链表中移动（第二次机会的时候要将这个页面从链表头移到链表尾），时钟算法使用环形链表，再使用一个指针指向最老的页面，避免了移动页面的开销；
- **最近未使用算法**NRU（Not Recently Used） 检查访问位R、修改位M，优先置换R=M=0，其次是（R=0, M=1）；
- **最近最少使用算法**LRU（Least Recently Used） 置换出未使用时间最长的一页；实现方式：维护时间戳，或者维护一个所有页面的链表。当一个页面被访问时，将这个页面移到链表表头。这样就能保证链表表尾的页面是最近最久未访问的。
- **最不经常使用算法**NFU 置换出访问次数最少的页面

### 内部碎片和外部碎片

1. **内部碎片**：已经被分配出去的的内存空间不经常使用，并且分配出去的内存空间大于请求所需的内存空间。
2. **外部碎片**：指可用空间还没有分配出去，但是可用空间由于大小太小而无法分配给申请空间的新进程的内存空间空闲块。

### 快表 TLB

也叫`地址转换后援缓冲器`实质是cache，它所缓存的是最近使用的数据的页表项（虚拟地址到物理地址的映射）。他的出现是为了加快访问数据（内存）的速度，减少重复的页表查找。当然它不是必须要有的。

### 内存管理单元 MMU

是一种负责处理CPU内存访问请求的计算机硬件。它的功能包括**虚拟地址到物理地址的转换、内存保护、中央处理器高速缓存的控制**。现代 CPU 基本上都选择了使用 MMU。

## Linux内存管理

![img](https://img.xiaoyou66.com/2021/04/11/963ced689e508.jpg)



这东西比较复杂，先暂时不深入，后续再研究研究

[linux内存管理（详解） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/149581303)

## 面试问题

### 物理地址、逻辑地址、线性地址

- **物理地址** 它是地址转换的最终地址，是内存单元**真正的**地址。如果采用了**分页机制**，那么线性地址会通过**页目录和页表**的方式转换为物理地址。如果没有启用则线性地址即为物理地址
- **逻辑地址** 在编写c语言的时候，通过&操作符可以读取指针变量本身的值，这个值就是**逻辑地址**。实际上是当前进程的数据段的地址，和真实的物理地址没有关系。只有当在Intel实模式下，逻辑地址==物理地址。我们平时的应用程序都是通过和逻辑地址打交道，至于分页，分段机制对他们而言是透明的。逻辑地址也称作虚拟地址
- **线性地址** 线性地址是逻辑地址到物理地址的**中间层**。我们编写的代码会存在一个逻辑地址或者是段中的偏移地址，通过相应的计算(加上基地址)生成线性地址。此时如果采用了分页机制，那么吸纳行地址再经过变换即产生物理地址。在Intelk 80386中地址空间容量为4G，各个进程地址空间隔离，意味着每个进程独享4G线性空间。多个进程难免出现进程之间的切换，线性空间随之切换。基于分页机制，对于4GB的线性地址一部分会被映射到物理内存，一部分映射到**磁盘**作为交换文件，一部分没有映射，通过下面加深一下印象

### 虚拟内存的应用与优点

　　虚拟内存很适合在多道程序设计系统中使用，许多程序的片段同时保存在内存中。当一个程序等待它的一部分读入内存时，可以把CPU交给另一个进程使用。虚拟内存的使用可以带来以下好处：

- 在内存中可以保留多个进程，系统并发度提高
- 解除了用户与内存之间的紧密约束，进程可以比内存的全部空间还大

### 颠簸

　　颠簸本质上是指频繁的页调度行为，具体来讲，进程发生缺页中断，这时，必须置换某一页。然而，其他所有的页都在使用，它置换一个页，但又立刻再次需要这个页。因此，会不断产生缺页中断，导致整个系统的效率急剧下降，这种现象称为颠簸（抖动）。

　　内存颠簸的解决策略包括：

- 如果是因为页面替换策略失误，可以修改替换算法来解决这个问题；
- 如果是因为运行的程序太多，造成程序无法同时将所有频繁访问的页面调入内存，则要降低多道程序的数量；
- 否则，还剩下两个办法：终止该进程或增加物理内存容量。

#### mmap是啥

mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。如下图所示：

![img](https://img.xiaoyou66.com/2021/04/12/431db58947f79.png)

参考：

[认真分析mmap：是什么 为什么 怎么用 - 胡潇 - 博客园 (cnblogs.com)](https://www.cnblogs.com/huxiao-tee/p/4660352.html)